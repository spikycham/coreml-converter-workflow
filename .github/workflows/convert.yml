name: Convert PT to MLPackage

on:
  workflow_dispatch:
    inputs:
      pt_url:
        description: 'URL to the .pt file'
        required: true
      py_url:
        description: 'URL to the .py file'
        required: true
      model_input:
        description: 'The input shape of model, e.g. 1,3,224,224'
        required: true
      model_name:
        description: 'Output name of model, e.g. citrus_count'
        required: true
      model_description:
        description: 'The desciption of model'
        required: true
      model_result_keys:
        description: 'Predict result keys split with comma, e.g. count,size'
        required: true

jobs:
  convert:
    runs-on: macos-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install torch torchvision coremltools

    - name: Download model files
      run: |
        curl -L ${{ github.event.inputs.pt_url }} -o ${{ github.event.inputs.model_name }}.pt
        curl -L ${{ github.event.inputs.py_url }} -o ${{ github.event.inputs.model_name }}.py

    - name: Convert PT to MLPackage
      env:
        MODEL_INPUT: ${{ github.event.inputs.model_input }}
        MODEL_NAME: ${{ github.event.inputs.model_name }}
      run: |
        python convert.py

    - name: Generate metadata and bundle model
      env:
        INPUT_NAME: ${{ github.event.inputs.model_name }}
        INPUT_DESC: ${{ github.event.inputs.model_description }}
        INPUT_SHAPE: ${{ github.event.inputs.model_input }}
        INPUT_KEYS: ${{ github.event.inputs.model_result_keys }}
      run: |
        BUNDLE_DIR="${INPUT_NAME}.bundle"
        mkdir -p "$BUNDLE_DIR"

        python - << 'EOF'
        import json
        import os

        meta = {
            "name": os.environ['INPUT_NAME'],
            "description": os.environ['INPUT_DESC'],
            "input_shape": os.environ['INPUT_SHAPE'],
            "result_keys": os.environ['INPUT_KEYS']
        }

        with open(f"{meta['name']}.json", "w") as f:
            json.dump(meta, f, indent=2)
        EOF

        if [ -d "${INPUT_NAME}.mlpackage" ]; then
          mv "${INPUT_NAME}.mlpackage" "$BUNDLE_DIR/"
        fi
        mv "${INPUT_NAME}.json" "$BUNDLE_DIR/"

    - name: Upload model bundle
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.model_name }}.bundle
        path: ${{ github.event.inputs.model_name }}.bundle
